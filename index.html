<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Career Laboratory Resource Website</title>

<!-- Google Identity Services (sign-in) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* â”€â”€ Design tokens â”€â”€ */
:root{
  --primary:#1e3a5f;--primary-dark:#152b47;--accent:#f0b429;--accent-dark:#d69e2e;
  --success:#2f855a;--danger:#c53030;
  --text:#1a202c;--muted:#718096;--bg:#f7fafc;--card:#fff;--border:#e2e8f0;
  --radius:10px;--radius-sm:6px;--shadow:0 4px 20px rgba(0,0,0,.08);
  --shadow-h:0 8px 30px rgba(0,0,0,.14);--t:.2s ease;
  --font:'Segoe UI',system-ui,sans-serif;--font-h:'Georgia','Times New Roman',serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);color:var(--text);background:var(--bg);font-size:16px;line-height:1.6;min-height:100vh;display:flex;flex-direction:column}
img{max-width:100%;display:block}
a{color:var(--primary);text-decoration:none}
a:hover{text-decoration:underline}
main{flex:1}

/* headings */
h1,h2,h3,h4{font-family:var(--font-h);line-height:1.25;color:var(--primary)}
h1{font-size:clamp(1.7rem,4vw,2.6rem)}h2{font-size:clamp(1.3rem,3vw,2rem)}h3{font-size:clamp(1.05rem,2vw,1.4rem)}
p{margin-bottom:1rem}

/* layout */
.container{max-width:1100px;margin:0 auto;padding:0 20px}
.section{padding:48px 0}
.grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:22px}
.flex-between{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.mt-2{margin-top:16px}.mt-3{margin-top:24px}.mb-2{margin-bottom:16px}.mb-3{margin-bottom:24px}
.hidden{display:none!important}

/* nav */
.site-header{background:var(--primary);position:sticky;top:0;z-index:999;box-shadow:0 2px 12px rgba(0,0,0,.3)}
.nav-inner{display:flex;align-items:center;justify-content:space-between;padding:0 20px;max-width:1100px;margin:0 auto;height:62px}
.nav-brand{color:#fff;font-family:var(--font-h);font-size:1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;user-select:none}
.nav-links{display:flex;gap:4px;list-style:none}
.nav-links a{color:rgba(255,255,255,.82);padding:7px 13px;border-radius:var(--radius-sm);font-size:.88rem;transition:var(--t);cursor:pointer}
.nav-links a:hover,.nav-links a.active{background:rgba(255,255,255,.15);color:#fff;text-decoration:none}
.nav-user{color:rgba(255,255,255,.7);font-size:.8rem;display:flex;align-items:center;gap:8px}
.user-badge{background:var(--accent);color:var(--primary-dark);padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700}
.hamburger{display:none;background:none;border:none;cursor:pointer;flex-direction:column;gap:5px;padding:4px}
.hamburger span{display:block;width:24px;height:2px;background:#fff;border-radius:2px}
@media(max-width:768px){
  .hamburger{display:flex}
  .nav-collapse{display:none;position:absolute;top:62px;left:0;right:0;background:var(--primary-dark);padding:12px;flex-direction:column}
  .nav-collapse.open{display:flex}
  .nav-links{flex-direction:column;width:100%}
  .nav-links a{padding:10px 16px;display:block}
  .nav-user{padding:10px 16px}
}

/* hero */
.hero{background:linear-gradient(135deg,var(--primary),#2d6a9f);color:#fff;padding:72px 20px;text-align:center}
.hero h1{color:#fff;margin-bottom:14px}
.hero p{color:rgba(255,255,255,.85);font-size:1.1rem;max-width:580px;margin:0 auto 26px}

/* cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform var(--t),box-shadow var(--t)}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-h)}
.card-thumb{width:100%;height:175px;object-fit:cover}
.card-thumb-placeholder{width:100%;height:175px;display:flex;align-items:center;justify-content:center;font-size:3rem}
.card-body{padding:18px;flex:1;display:flex;flex-direction:column}
.card-title{font-size:1.05rem;margin-bottom:7px;color:var(--primary);font-family:var(--font-h)}
.card-desc{color:var(--muted);font-size:.88rem;flex:1;margin-bottom:14px}
.card-footer{margin-top:auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.card-meta{font-size:.78rem;color:var(--muted)}

/* buttons */
.btn{display:inline-flex;align-items:center;gap:5px;padding:9px 18px;border-radius:var(--radius-sm);border:none;cursor:pointer;font:inherit;font-size:.88rem;font-weight:600;text-decoration:none;transition:background var(--t),transform var(--t);white-space:nowrap}
.btn:active{transform:scale(.98)}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);text-decoration:none}
.btn-accent{background:var(--accent);color:var(--primary-dark)}.btn-accent:hover{background:var(--accent-dark);text-decoration:none}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#9b2c2c;text-decoration:none}
.btn-ghost{background:transparent;color:var(--primary);border:2px solid var(--primary)}.btn-ghost:hover{background:var(--primary);color:#fff;text-decoration:none}
.btn-sm{padding:5px 11px;font-size:.78rem}
.btn-lg{padding:13px 26px;font-size:.98rem}

/* badges */
.badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-primary{background:#ebf4ff;color:var(--primary)}
.badge-success{background:#f0fff4;color:var(--success)}

/* tag pills */
.tag-pill{display:inline-block;padding:3px 11px;border-radius:999px;border:1px solid var(--border);font-size:.78rem;cursor:pointer;color:var(--muted);transition:var(--t)}
.tag-pill:hover,.tag-pill.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* search */
.search-bar{display:flex;gap:8px;max-width:500px;width:100%}
.search-bar input{flex:1;padding:9px 15px;border:1px solid var(--border);border-radius:var(--radius-sm);font:inherit;font-size:.95rem}
.search-bar input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,58,95,.1)}
.ac-wrap{position:relative;flex:1}
.ac-drop{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);box-shadow:var(--shadow);z-index:200;max-height:260px;overflow-y:auto;display:none}
.ac-drop.open{display:block}
.ac-item{padding:9px 13px;cursor:pointer;font-size:.88rem;display:flex;align-items:center;gap:8px}
.ac-item:hover{background:#f7fafc}
.ac-type{font-size:.68rem;background:var(--primary);color:#fff;padding:2px 6px;border-radius:3px;flex-shrink:0}

/* pagination */
.pagination{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin-top:32px}
.page-btn{padding:7px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;color:var(--primary);font-size:.88rem;transition:var(--t)}
.page-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
.page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* forms */
.form-group{margin-bottom:16px}
.form-label{display:block;font-weight:600;margin-bottom:5px;font-size:.88rem}
.form-label .req{color:var(--danger);margin-left:3px}
.form-control{width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:var(--radius-sm);font:inherit;font-size:.93rem;background:#fff;transition:border-color var(--t)}
.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,58,95,.1)}
textarea.form-control{min-height:110px;resize:vertical}
.form-hint{font-size:.78rem;color:var(--muted);margin-top:3px}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:16px}

/* rich text toolbar */
.toolbar{display:flex;flex-wrap:wrap;gap:3px;padding:7px;background:#f1f5f9;border:1px solid var(--border);border-bottom:none;border-radius:var(--radius-sm) var(--radius-sm) 0 0}
.toolbar button{padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;cursor:pointer;font-size:.82rem}
.toolbar button:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
.editor{width:100%;min-height:180px;border:1px solid var(--border);border-radius:0 0 var(--radius-sm) var(--radius-sm);padding:11px;font:inherit;font-size:.93rem;line-height:1.6;background:#fff}
.editor:focus{outline:none;border-color:var(--primary)}

/* course detail */
.video-wrap{position:relative;padding-top:56.25%;border-radius:var(--radius);overflow:hidden;background:#000}
.video-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:none}
.pdf-box{display:flex;align-items:center;gap:15px;padding:18px;background:#fff8dc;border:1px solid #e6d17f;border-radius:var(--radius)}
.pdf-icon{font-size:2.2rem}
.rich-content{line-height:1.85}
.rich-content h1,.rich-content h2,.rich-content h3{margin:22px 0 9px}
.rich-content ul,.rich-content ol{padding-left:22px;margin-bottom:14px}
.rich-content blockquote{border-left:4px solid var(--primary);padding:11px 15px;background:rgba(30,58,95,.04);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin:14px 0;color:var(--muted)}

/* page header band */
.page-header{background:linear-gradient(135deg,var(--primary),#2d6a9f);color:#fff;padding:36px 20px}
.page-header h1{color:#fff;margin-bottom:6px}.page-header p{color:rgba(255,255,255,.8);margin:0}

/* staff / dashboard */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;text-align:center;box-shadow:var(--shadow)}
.stat-num{font-size:2.2rem;font-weight:800;color:var(--primary)}
.stat-label{color:var(--muted);font-size:.82rem;margin-top:3px}
.data-table{width:100%;border-collapse:collapse;font-size:.88rem}
.data-table th{background:#f1f5f9;text-align:left;padding:9px 13px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)}
.data-table td{padding:9px 13px;border-bottom:1px solid var(--border);vertical-align:middle}
.data-table tr:hover td{background:#f7fafc}
.actions{display:flex;gap:5px}

/* alerts */
.alert{padding:12px 16px;border-radius:var(--radius-sm);margin-bottom:14px;font-size:.88rem;display:flex;align-items:flex-start;gap:9px}
.alert-danger{background:#fff5f5;border:1px solid #feb2b2;color:var(--danger)}
.alert-info{background:#ebf8ff;border:1px solid #90cdf4;color:#2b6cb0}

/* toasts */
#toast-box{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:9px}
.toast{padding:12px 18px;border-radius:var(--radius-sm);color:#fff;font-size:.88rem;box-shadow:var(--shadow-h);animation:slideIn .3s ease;max-width:300px}
.toast-ok{background:var(--success)}.toast-err{background:var(--danger)}
@keyframes slideIn{from{transform:translateX(120%);opacity:0}to{transform:none;opacity:1}}

/* spinner / loader */
.spinner{width:34px;height:34px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;margin:22px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;align-items:center;justify-content:center}
.loader-overlay.show{display:flex}
.loader-box{background:#fff;padding:26px 34px;border-radius:12px;text-align:center}

/* panels */
.panel{max-width:440px;margin:70px auto;padding:36px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);text-align:center}
.panel-icon{font-size:3.2rem;margin-bottom:14px}

/* empty state */
.empty{text-align:center;padding:60px 24px;color:var(--muted)}
.empty-icon{font-size:3.2rem;margin-bottom:14px}

/* post */
.post-meta{display:flex;flex-wrap:wrap;gap:12px;color:var(--muted);font-size:.83rem;margin:9px 0 22px}
.featured-img{width:100%;max-height:300px;object-fit:cover;border-radius:var(--radius);margin-bottom:24px}
.filter-bar{display:flex;flex-wrap:wrap;gap:7px;align-items:center;margin-bottom:22px}

/* footer */
.site-footer{background:var(--primary-dark);color:rgba(255,255,255,.7);padding:32px 20px;text-align:center;font-size:.82rem;margin-top:auto}

@media(max-width:640px){.section{padding:30px 0}.hero{padding:48px 16px}.panel{margin:36px 16px;padding:26px 18px}}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loader-overlay" id="loader">
  <div class="loader-box">
    <div class="spinner"></div>
    <p style="color:#555;font-size:.88rem;margin-top:10px">Loadingâ€¦</p>
  </div>
</div>
<div id="toast-box"></div>

<!-- Nav (hidden until authenticated) -->
<header class="site-header hidden" id="site-header">
  <div class="nav-inner">
    <div class="nav-brand" onclick="route('home')"><img src="unnamed.png" height="30" style="height:30px;width:auto;vertical-align:middle;border-radius:5px;margin-right:4px" alt="Silver Oaks Career Lab" onerror="this.style.display='none'"> <span id="nav-appname">Career Lab</span></div>
    <button class="hamburger" onclick="toggleNav()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-collapse" id="nav-collapse">
      <ul class="nav-links" id="nav-links">
        <li><a onclick="route('home')"    data-page="home">Home</a></li>
        <li><a onclick="route('courses')" data-page="courses">Courses</a></li>
        <li><a onclick="route('blog')"    data-page="blog">Blog</a></li>
        <li id="nav-staff" class="hidden"><a onclick="route('staff')" data-page="staff" style="color:#f0b429">âš™ Staff</a></li>
      </ul>
      <div class="nav-user" id="nav-user"></div>
    </div>
  </div>
</header>

<main id="app">
  <!-- Splash shown before GIS loads -->
  <div style="display:flex;align-items:center;justify-content:center;min-height:80vh">
    <div class="spinner"></div>
  </div>
</main>

<footer class="site-footer hidden" id="site-footer">
  <div class="container">
    <p>ğŸ“ <strong>Career Laboratory Resource Website</strong> &nbsp;|&nbsp; Internal â€” Silver Oaks Hyderabad &nbsp;|&nbsp; @hyd.silveroaks.co.in only</p>
    <p style="margin-top:6px;opacity:.5">Â© <span id="footer-year"></span> Silver Oaks Career Council</p>
  </div>
</footer>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€” Fill these in before deploying
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var GAS_URL   = "https://script.google.com/macros/s/AKfycbwF6RKIq7ccU1QaF-7S7c47554tB0mbHsXrbr7G_l-JKXlH6C-m9QiRrBthWkc2sfsX/exec";
  // e.g. "https://script.google.com/macros/s/AKfyc.../exec"
var CLIENT_ID = "PASTE_YOUR_GOOGLE_OAUTH_CLIENT_ID_HERE";
  // e.g. "123456789-abc.apps.googleusercontent.com"
var APP_NAME  = "Career Laboratory Resource Website";
var PAGE_SIZE = 9;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var _idToken = sessionStorage.getItem("gas_id_token") || null;
var APP_USER = null;   // { email, name, role, isAdmin }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById("footer-year").textContent = new Date().getFullYear();

// Wait for GIS library to load, then initialize
window.onGoogleLibraryLoad = function() {
  google.accounts.id.initialize({
    client_id:   CLIENT_ID,
    callback:    handleCredential,
    auto_select: true,
  });

  if (_idToken) {
    // Try to reuse cached token
    verifyAndStart(_idToken);
  } else {
    // Show sign-in UI and trigger one-tap prompt
    renderLogin(null);
    google.accounts.id.prompt();
  }
};

// Fallback: if library already loaded before onGoogleLibraryLoad was set
if (window.google && window.google.accounts) {
  window.onGoogleLibraryLoad();
}

function handleCredential(response) {
  _idToken = response.credential;
  sessionStorage.setItem("gas_id_token", _idToken);
  verifyAndStart(_idToken);
}

function verifyAndStart(token) {
  showLoader();
  fetchGAS("me", {token: token}, function(user) {
    hideLoader();
    APP_USER = user;
    _idToken = token;
    showChrome();
    route("home");
  }, function(err) {
    hideLoader();
    // Token expired or domain mismatch
    _idToken = null;
    sessionStorage.removeItem("gas_id_token");
    APP_USER = null;
    renderLogin(err.message);
    if (window.google && google.accounts) {
      google.accounts.id.prompt();
    }
  });
}

function showChrome() {
  document.getElementById("site-header").classList.remove("hidden");
  document.getElementById("site-footer").classList.remove("hidden");
  document.getElementById("nav-user").innerHTML =
    "ğŸ‘¤ " + esc(APP_USER.name) +
    (APP_USER.isAdmin ? ' <span class="user-badge">' + esc(APP_USER.role) + "</span>" : "");
  if (APP_USER.isAdmin) {
    document.getElementById("nav-staff").classList.remove("hidden");
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var _page  = "home";
var _state = {};

function route(page, params) {
  _page  = page;
  _state = params || {};
  setActiveNav(page);
  window.scrollTo(0, 0);
  document.getElementById("nav-collapse").classList.remove("open");

  switch (page) {
    case "home":    pageHome();    break;
    case "courses": pageCourses(); break;
    case "course":  pageCourse(_state.id);  break;
    case "blog":    pageBlog();    break;
    case "post":    pagePost(_state.id);    break;
    case "staff":
      if (APP_USER && APP_USER.isAdmin) pageStaff(); else render403();
      break;
    case "staff-course-form":
      if (APP_USER && APP_USER.isAdmin) pageStaffCourseForm(_state.course); else render403();
      break;
    case "staff-blog-form":
      if (APP_USER && APP_USER.isAdmin) pageStaffBlogForm(_state.post); else render403();
      break;
    default: render404();
  }
}

function setActiveNav(page) {
  document.querySelectorAll(".nav-links a").forEach(function(a) {
    a.classList.toggle("active", a.dataset.page === page);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAS API TRANSPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/**
 * GET â€” read actions.
 * Builds URL with action + token + extra params, fetches JSON.
 */
function api(action, params, onOk, onErr) {
  var p = Object.assign({}, params, { action: action, token: _idToken || "" });
  var qs = Object.keys(p).map(function(k) {
    return encodeURIComponent(k) + "=" + encodeURIComponent(p[k] !== undefined ? p[k] : "");
  }).join("&");
  showLoader();
  fetch(GAS_URL + "?" + qs)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      hideLoader();
      if (data && data.error) { (onErr || defaultErr)(new Error(data.error)); return; }
      onOk(data);
    })
    .catch(function(e) { hideLoader(); (onErr || defaultErr)(e); });
}

/**
 * POST â€” write actions.
 * Uses text/plain Content-Type so GAS avoids CORS preflight.
 */
function apiPost(action, body, onOk, onErr) {
  var payload = Object.assign({}, body, { action: action, token: _idToken || "" });
  showLoader();
  fetch(GAS_URL, {
    method:  "POST",
    headers: { "Content-Type": "text/plain" },
    body:    JSON.stringify(payload),
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      hideLoader();
      if (data && data.error) { (onErr || defaultErr)(new Error(data.error)); return; }
      onOk(data);
    })
    .catch(function(e) { hideLoader(); (onErr || defaultErr)(e); });
}

/** Internal â€” used only by verifyAndStart (no loader managed here) */
function fetchGAS(action, params, onOk, onErr) {
  var p = Object.assign({}, params, { action: action });
  var qs = Object.keys(p).map(function(k) {
    return encodeURIComponent(k) + "=" + encodeURIComponent(p[k] !== undefined ? p[k] : "");
  }).join("&");
  fetch(GAS_URL + "?" + qs)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data && data.error) { onErr(new Error(data.error)); return; }
      onOk(data);
    })
    .catch(onErr);
}

function defaultErr(e) {
  toast(e.message || "Something went wrong.", "err");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoader() { document.getElementById("loader").classList.add("show"); }
function hideLoader() { document.getElementById("loader").classList.remove("show"); }
function toggleNav()  { document.getElementById("nav-collapse").classList.toggle("open"); }

function toast(msg, type) {
  var box = document.getElementById("toast-box");
  var el  = document.createElement("div");
  el.className = "toast toast-" + (type === "err" ? "err" : "ok");
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(function() {
    el.style.opacity = "0"; el.style.transition = "opacity .4s";
    setTimeout(function() { el.remove(); }, 450);
  }, 3200);
}

function esc(s) {
  return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function fmtDate(d) {
  var dt = new Date(d);
  return isNaN(dt) ? (d || "") : dt.toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"});
}
function stripHtml(html) {
  var t = document.createElement("div"); t.innerHTML = html || ""; return (t.textContent || "").trim();
}

/* Autocomplete */
function initAC(inputId, dropId) {
  var inp = document.getElementById(inputId);
  var drop = document.getElementById(dropId);
  if (!inp || !drop) return;
  var timer;
  inp.addEventListener("input", function() {
    clearTimeout(timer);
    var q = inp.value.trim();
    if (q.length < 2) { drop.classList.remove("open"); return; }
    timer = setTimeout(function() {
      api("search", {q: q}, function(res) {
        drop.innerHTML = "";
        var items = [];
        (res.courses || []).forEach(function(c) { items.push({type:"Course",label:c.Title,id:c.ID,page:"course"}); });
        (res.posts   || []).forEach(function(p) { items.push({type:"Blog",  label:p.Title,id:p.ID,page:"post"}); });
        if (!items.length) {
          drop.innerHTML = "<div class='ac-item' style='color:#999'>No results</div>";
        } else {
          items.forEach(function(item) {
            var div = document.createElement("div");
            div.className = "ac-item";
            div.innerHTML = "<span class='ac-type'>"+esc(item.type)+"</span><span>"+esc(item.label)+"</span>";
            div.onclick = function() { route(item.page, {id: item.id}); drop.classList.remove("open"); };
            drop.appendChild(div);
          });
        }
        drop.classList.add("open");
      }, function() { drop.classList.remove("open"); });
    }, 280);
  });
  document.addEventListener("click", function(e) {
    if (!inp.contains(e.target) && !drop.contains(e.target)) drop.classList.remove("open");
  });
}

/* Rich text toolbar */
function fmt(cmd) {
  document.getElementById("f-content") && document.getElementById("f-content").focus();
  document.getElementById("p-content") && document.getElementById("p-content").focus();
  if      (cmd === "Bold")      document.execCommand("bold");
  else if (cmd === "Italic")    document.execCommand("italic");
  else if (cmd === "Underline") document.execCommand("underline");
  else if (cmd === "H2")        document.execCommand("formatBlock",false,"h2");
  else if (cmd === "H3")        document.execCommand("formatBlock",false,"h3");
  else if (cmd === "UL")        document.execCommand("insertUnorderedList");
  else if (cmd === "OL")        document.execCommand("insertOrderedList");
  else if (cmd === "Quote")     document.execCommand("formatBlock",false,"blockquote");
  else if (cmd === "Link") {
    var url = prompt("URL:");
    if (url) document.execCommand("createLink",false,url);
  }
}

/* Pagination */
function renderPagination(key, total, offset, onPage) {
  var el = document.getElementById(key);
  if (!el || total <= PAGE_SIZE) { if (el) el.innerHTML = ""; return; }
  var pages = Math.ceil(total / PAGE_SIZE);
  var cur   = Math.floor(offset / PAGE_SIZE);
  var html  = "";
  if (cur > 0)       html += '<button class="page-btn" onclick="_pg(\''+key+'\','+(cur-1)+')">â† Prev</button>';
  for (var i = 0; i < pages; i++) {
    html += '<button class="page-btn'+(i===cur?" active":"")+'" onclick="_pg(\''+key+'\','+i+')">'+(i+1)+'</button>';
  }
  if (cur < pages-1) html += '<button class="page-btn" onclick="_pg(\''+key+'\','+(cur+1)+')">Next â†’</button>';
  el.innerHTML = html;
  window["_pgcb_"+key] = onPage;
}
function _pg(key, idx) {
  var cb = window["_pgcb_"+key];
  if (cb) cb(idx * PAGE_SIZE);
}

/* Status badge */
function statusBadge(s) {
  return s === "Published"
    ? '<span class="badge badge-success">Published</span>'
    : '<span class="badge" style="background:#fef3c7;color:#92400e">Draft</span>';
}

/* Card builders */
function courseCard(c) {
  var thumb = c.ThumbnailURL
    ? '<img class="card-thumb" src="'+esc(c.ThumbnailURL)+'" alt="'+esc(c.Title)+'" onerror="this.parentElement.innerHTML=\'<div class=card-thumb-placeholder style=background:linear-gradient(135deg,#1e3a5f,#2d6a9f)>ğŸ“</div>\'">'
    : '<div class="card-thumb-placeholder" style="background:linear-gradient(135deg,#1e3a5f,#2d6a9f)">ğŸ“</div>';
  return '<div class="card">' + thumb +
    '<div class="card-body">' +
    '<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:9px">' +
    '<span class="badge badge-primary">'+esc(c.Category||"General")+'</span>' +
    (c.Grade ? '<span class="badge" style="background:#e0f2fe;color:#075985">'+esc(c.Grade)+'</span>' : "") +
    (c.YouTubeURL ? '<span class="badge" style="background:#fffbeb;color:#92400e">ğŸ¬ Video</span>' : "") +
    (c.PDFLink    ? '<span class="badge badge-success">ğŸ“„ PDF</span>' : "") +
    '</div>' +
    '<h3 class="card-title">'+esc(c.Title)+'</h3>' +
    '<p class="card-desc">'+esc((c.Description||"").slice(0,110))+((c.Description||"").length>110?"â€¦":"")+'</p>' +
    '<div class="card-footer">' +
    '<span class="card-meta">ğŸ‘¨â€ğŸ« '+esc(c.Instructor||"Staff")+'</span>' +
    '<button class="btn btn-primary btn-sm" onclick="route(\'course\',{id:\''+esc(c.ID)+'\'})">Open â†’</button>' +
    '</div></div></div>';
}

function postCard(p) {
  var excerpt = stripHtml(p.Content||"").slice(0,115);
  var thumb   = p.FeaturedImageURL
    ? '<img class="card-thumb" src="'+esc(p.FeaturedImageURL)+'" alt="'+esc(p.Title)+'" onerror="this.parentElement.innerHTML=\'<div class=card-thumb-placeholder style=background:linear-gradient(135deg,#553c9a,#805ad5)>âœï¸</div>\'">'
    : '<div class="card-thumb-placeholder" style="background:linear-gradient(135deg,#553c9a,#805ad5)">âœï¸</div>';
  var tags = p.Tags ? p.Tags.split(",").map(function(t){ t=t.trim(); return t?'<a class="tag-pill" style="font-size:.7rem" href="#" onclick="event.preventDefault();setBlogTag(\''+esc(t)+'\')">'+esc(t)+'</a>':""}).join("") : "";
  return '<div class="card">'+thumb+
    '<div class="card-body">'+
    '<h3 class="card-title">'+esc(p.Title)+'</h3>'+
    '<p class="card-desc">'+esc(excerpt)+(excerpt.length>=115?"â€¦":"")+'</p>'+
    (tags?'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tags+'</div>':'')+
    '<div class="card-footer">'+
    '<span class="card-meta">ğŸ“… '+esc(fmtDate(p.CreatedDate))+'</span>'+
    '<button class="btn btn-primary btn-sm" onclick="route(\'post\',{id:\''+esc(p.ID)+'\'})">Read â†’</button>'+
    '</div></div></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE RENDERERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Login â”€â”€ */
function renderLogin(errMsg) {
  document.getElementById("site-header").classList.add("hidden");
  document.getElementById("site-footer").classList.add("hidden");
  document.getElementById("app").innerHTML =
    '<div style="background:linear-gradient(135deg,#1e3a5f,#2d6a9f);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">' +
    '<div style="width:100%;max-width:420px">' +
    '<div style="text-align:center;margin-bottom:24px">' +
    '<div style="font-size:3.2rem">ğŸ“</div>' +
    '<h1 style="color:#fff;font-size:1.5rem;margin-top:8px">'+APP_NAME+'</h1>' +
    '<p style="color:rgba(255,255,255,.75);font-size:.88rem">Silver Oaks Hyderabad â€” Internal Platform</p>' +
    '</div>' +
    '<div style="background:#fff;border-radius:14px;padding:34px;box-shadow:0 20px 60px rgba(0,0,0,.3)">' +
    '<h2 style="text-align:center;margin-bottom:8px">Welcome</h2>' +
    '<p style="text-align:center;color:#718096;font-size:.88rem;margin-bottom:22px">Only <strong>@hyd.silveroaks.co.in</strong> accounts are allowed.</p>' +
    (errMsg ? '<div class="alert alert-danger">âš  '+esc(errMsg)+'</div>' : '<div class="alert alert-info" style="justify-content:center">ğŸ” Click below to sign in with your school account.</div>') +
    '<div id="g_signin_btn" style="display:flex;justify-content:center;margin-top:18px"></div>' +
    '</div></div></div>';

  // Render the Google Sign-In button
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.renderButton(
      document.getElementById("g_signin_btn"),
      { theme: "outline", size: "large", width: 340 }
    );
  }
}

/* â”€â”€ 403 â”€â”€ */
function render403() {
  document.getElementById("app").innerHTML =
    '<div class="panel"><div class="panel-icon">ğŸš«</div>' +
    '<h2 style="color:var(--danger)">Access Denied</h2>' +
    '<p>You need Admin or Editor role to view this page.</p>' +
    '<button class="btn btn-primary mt-2" onclick="route(\'home\')">â† Home</button></div>';
}

/* â”€â”€ 404 â”€â”€ */
function render404() {
  document.getElementById("app").innerHTML =
    '<div class="panel"><div class="panel-icon">ğŸ”</div>' +
    '<h2>Not Found</h2><p>This page does not exist.</p>' +
    '<button class="btn btn-primary mt-2" onclick="route(\'home\')">â† Home</button></div>';
}

/* â”€â”€ HOME â”€â”€ */
function pageHome() {
  document.getElementById("app").innerHTML =
    '<section class="hero"><div class="container">' +
    '<h1>Career Laboratory Resource Website</h1>' +
    '<p>Your internal hub for courses, PDFs, videos and career resources â€” Silver Oaks Hyderabad.</p>' +
    '<div class="search-bar" style="justify-content:center;max-width:480px;margin:0 auto">' +
    '<div class="ac-wrap"><input id="h-srch" type="text" placeholder="Search courses and postsâ€¦" autocomplete="off">' +
    '<div class="ac-drop" id="h-ac"></div></div>' +
    '<button class="btn btn-accent btn-lg" onclick="doHomeSearch()">Search</button>' +
    '</div></div></section>' +

    '<section class="section" style="background:#fff"><div class="container">' +
    '<div class="flex-between mb-3"><h2>ğŸ“š Featured Courses</h2><button class="btn btn-ghost btn-sm" onclick="route(\'courses\')">View All â†’</button></div>' +
    '<div class="grid-3" id="home-courses"><div class="spinner"></div></div>' +
    '</div></section>' +

    '<section class="section"><div class="container">' +
    '<div class="flex-between mb-3"><h2>âœï¸ Latest from Blog</h2><button class="btn btn-ghost btn-sm" onclick="route(\'blog\')">View All â†’</button></div>' +
    '<div class="grid-3" id="home-posts"><div class="spinner"></div></div>' +
    '</div></section>' +

    '<section style="background:var(--primary);color:#fff;padding:40px 20px;text-align:center"><div class="container">' +
    '<h2 style="color:#fff;margin-bottom:10px">ğŸ” Secure Internal Platform</h2>' +
    '<p style="color:rgba(255,255,255,.8);max-width:560px;margin:0 auto 22px">Exclusively for Silver Oaks Hyderabad staff and students.</p>' +
    '<div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap">' +
    ['ğŸ“ Courses','ğŸ“„ PDFs','ğŸ¬ Videos','âœï¸ Blog'].map(function(x) {
      return '<div style="background:rgba(255,255,255,.1);padding:16px 24px;border-radius:10px"><div style="font-size:1.7rem">'+x.split(" ")[0]+'</div><div style="margin-top:5px;color:rgba(255,255,255,.85)">'+x.split(" ").slice(1).join(" ")+'</div></div>';
    }).join("") +
    '</div></div></section>';

  initAC("h-srch", "h-ac");

  api("home", {}, function(data) {
    var cEl = document.getElementById("home-courses");
    if (cEl) cEl.innerHTML = (data.featuredCourses && data.featuredCourses.length)
      ? data.featuredCourses.map(courseCard).join("")
      : '<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“­</div><p>No courses yet.</p></div>';

    var pEl = document.getElementById("home-posts");
    if (pEl) pEl.innerHTML = (data.featuredPosts && data.featuredPosts.length)
      ? data.featuredPosts.map(postCard).join("")
      : '<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“­</div><p>No posts yet.</p></div>';
  });
}

function doHomeSearch() {
  var el = document.getElementById("h-srch");
  route("courses", { q: el ? el.value.trim() : "" });
}

/* â”€â”€ COURSES â”€â”€ */
var _cState = { q:"", category:"", grade:"", offset:0 };

function pageCourses(opts) {
  if (opts) { _cState.q = opts.q||""; _cState.category = opts.category||""; _cState.grade = opts.grade||""; _cState.offset = opts.offset||0; }

  var GRADE_LABELS = ["Class 7","Class 8","Class 9","Class 10","Class 11","Class 12"];

  document.getElementById("app").innerHTML =
    '<div class="page-header"><div class="container"><h1>ğŸ“š Courses</h1><p>All published learning resources.</p></div></div>' +
    '<section class="section"><div class="container">' +
    // Grade tab row
    '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px">' +
    '<button class="btn '+ (_cState.grade===''?'btn-primary':'btn-ghost') +'" style="padding:5px 14px;font-size:.85rem" onclick="setGradeFilter(\'\')">All Classes</button>' +
    GRADE_LABELS.map(function(g){
      return '<button class="btn '+ (_cState.grade===g?'btn-primary':'btn-ghost') +'" style="padding:5px 14px;font-size:.85rem" onclick="setGradeFilter(\''+g+'\')">' + g + '</button>';
    }).join("") +
    '</div>' +
    '<div class="flex-between mb-3">' +
    '<div class="search-bar" style="max-width:none;flex:1;min-width:220px">' +
    '<div class="ac-wrap"><input id="c-srch" type="text" placeholder="Search coursesâ€¦" value="'+esc(_cState.q)+'" autocomplete="off">' +
    '<div class="ac-drop" id="c-ac"></div></div>' +
    '<button class="btn btn-primary" onclick="courseSearch()">Search</button>' +
    (_cState.q||_cState.category||_cState.grade ? '<button class="btn btn-ghost" onclick="clearCourseFilter()">Clear</button>' : "") +
    '</div>' +
    '<select id="c-cat" class="form-control" style="width:auto;min-width:150px" onchange="courseSearch()"><option value="">All Categories</option></select>' +
    '</div>' +
    '<p id="c-count" style="color:var(--muted);font-size:.85rem;margin-bottom:18px"></p>' +
    '<div class="grid-3" id="c-grid"><div class="spinner"></div></div>' +
    '<div class="pagination" id="c-pages"></div>' +
    '</div></section>';

  initAC("c-srch", "c-ac");

  api("courses", { search: _cState.q, category: _cState.category, grade: _cState.grade, offset: _cState.offset, limit: PAGE_SIZE }, function(result) {
    // Populate category dropdown
    api("home", {}, function(meta) {
      var sel = document.getElementById("c-cat");
      if (sel && meta.categories) {
        meta.categories.forEach(function(cat) {
          var opt = document.createElement("option");
          opt.value = cat; opt.textContent = cat;
          if (_cState.category === cat) opt.selected = true;
          sel.appendChild(opt);
        });
      }
    });

    var grid = document.getElementById("c-grid");
    var cnt  = document.getElementById("c-count");
    var end  = Math.min(_cState.offset + PAGE_SIZE, result.total);
    if (cnt) cnt.textContent = "Showing "+(_cState.offset+1)+"â€“"+end+" of "+result.total+" courses"+(_cState.q?' matching "'+_cState.q+'"':"")+(_cState.category?" in "+_cState.category:"")+(_cState.grade?" Â· "+_cState.grade:"");

    if (grid) grid.innerHTML = (result.rows && result.rows.length)
      ? result.rows.map(courseCard).join("")
      : '<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“­</div><p>No courses found. <a href="#" onclick="clearCourseFilter()">Reset</a></p></div>';

    renderPagination("c-pages", result.total, _cState.offset, function(off) { _cState.offset = off; pageCourses(); });
  });
}

function courseSearch() {
  _cState.q        = (document.getElementById("c-srch")||{}).value || "";
  _cState.category = (document.getElementById("c-cat")||{}).value  || "";
  _cState.offset   = 0;
  pageCourses();
}
function setGradeFilter(g) { _cState.grade = g; _cState.offset = 0; pageCourses(); }
function clearCourseFilter() { _cState = {q:"",category:"",grade:"",offset:0}; pageCourses(); }

/* â”€â”€ COURSE DETAIL â”€â”€ */
function pageCourse(id) {
  if (!id) { render404(); return; }
  document.getElementById("app").innerHTML = '<div class="container section"><div class="spinner"></div></div>';

  api("course", {id: id}, function(c) {
    var html = '<section class="section"><div class="container" style="max-width:820px">';

    /* 1. Title + thumbnail */
    html += '<div style="margin-bottom:10px">' +
      '<div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px">' +
      '<span class="badge badge-primary">'+esc(c.Category||"General")+'</span>' +
      (c.Grade      ? '<span class="badge" style="background:#e0f2fe;color:#075985">'+esc(c.Grade)+'</span>' : "") +
      (c.Instructor ? '<span class="badge" style="background:#fffbeb;color:#92400e">ğŸ‘¨â€ğŸ« '+esc(c.Instructor)+'</span>' : "") +
      '</div><h1>'+esc(c.Title)+'</h1>' +
      (c.Description ? '<p style="color:var(--muted);margin-top:7px">'+esc(c.Description)+'</p>' : "") +
      '</div>';

    if (c.ThumbnailURL) {
      html += '<img src="'+esc(c.ThumbnailURL)+'" alt="'+esc(c.Title)+'" style="width:100%;border-radius:var(--radius);max-height:340px;object-fit:cover;margin-bottom:28px" onerror="this.style.display=\'none\'">';
    }

    /* 2. YouTube embed */
    if (c._embedUrl) {
      html += '<div class="card mb-3"><div class="card-body" style="padding:18px 18px 12px"><h3>ğŸ¬ Video Lesson</h3></div>' +
        '<div class="video-wrap"><iframe src="'+esc(c._embedUrl)+'" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe></div></div>';
    }

    /* 3. PDF download */
    if (c._downloadUrl) {
      html += '<div class="pdf-box mb-3"><div class="pdf-icon">ğŸ“„</div><div>' +
        '<h4>Course PDF</h4><p style="color:var(--muted);font-size:.85rem;margin-bottom:8px">Download the course materials.</p>' +
        '<a href="'+esc(c._downloadUrl)+'" target="_blank" class="btn btn-primary btn-sm">â¬‡ Download PDF</a>' +
        '</div></div>';
    }

    /* 4. Rich content */
    if (c.Content) {
      html += '<div class="card"><div class="card-body"><h3 style="margin-bottom:14px">ğŸ“– Course Content</h3>' +
        '<div class="rich-content" id="course-body"></div></div></div>';
    }

    html += '<div style="margin-top:28px"><button class="btn btn-ghost" onclick="route(\'courses\')">â† Back to Courses</button></div>';
    html += '</div></section>';

    document.getElementById("app").innerHTML = html;
    if (c.Content) {
      var el = document.getElementById("course-body");
      if (el) el.innerHTML = c.Content;
    }
  }, function() { render404(); });
}

/* â”€â”€ BLOG LIST â”€â”€ */
var _bState = { q:"", tag:"", offset:0 };

function pageBlog(opts) {
  if (opts) { _bState.q = opts.q||""; _bState.tag = opts.tag||""; _bState.offset = opts.offset||0; }

  document.getElementById("app").innerHTML =
    '<div class="page-header"><div class="container"><h1>âœï¸ Blog</h1><p>Insights, tips and career resources from the team.</p></div></div>' +
    '<section class="section"><div class="container">' +
    '<div class="search-bar mb-3" style="max-width:480px">' +
    '<div class="ac-wrap"><input id="b-srch" type="text" placeholder="Search postsâ€¦" value="'+esc(_bState.q)+'" autocomplete="off">' +
    '<div class="ac-drop" id="b-ac"></div></div>' +
    '<button class="btn btn-primary" onclick="blogSearch()">Search</button>' +
    (_bState.q||_bState.tag ? '<button class="btn btn-ghost" onclick="clearBlogFilter()">Clear</button>' : "") +
    '</div>' +
    '<div class="filter-bar" id="b-tags"></div>' +
    '<p id="b-count" style="color:var(--muted);font-size:.85rem;margin-bottom:18px"></p>' +
    '<div class="grid-3" id="b-grid"><div class="spinner"></div></div>' +
    '<div class="pagination" id="b-pages"></div>' +
    '</div></section>';

  initAC("b-srch", "b-ac");

  api("posts", { search: _bState.q, tag: _bState.tag, offset: _bState.offset, limit: PAGE_SIZE }, function(result) {
    // Build tag pills from home data
    api("home", {}, function(meta) {
      var bar = document.getElementById("b-tags");
      if (bar && meta.allTags && meta.allTags.length) {
        bar.innerHTML = '<span style="font-size:.82rem;color:var(--muted)">Filter:</span>' +
          '<a class="tag-pill'+(!_bState.tag?" active":"")+'" href="#" onclick="event.preventDefault();setBlogTag(\'\')">All</a>' +
          meta.allTags.map(function(t) {
            return '<a class="tag-pill'+(_bState.tag===t?" active":"")+'" href="#" onclick="event.preventDefault();setBlogTag(\''+esc(t)+'\')">'+esc(t)+'</a>';
          }).join("");
      }
    });

    var grid = document.getElementById("b-grid");
    var cnt  = document.getElementById("b-count");
    if (cnt) cnt.textContent = result.total + " post"+(result.total!==1?"s":"")+(_bState.q?' matching "'+_bState.q+'"':"")+(_bState.tag?" tagged #"+_bState.tag:"");

    if (grid) grid.innerHTML = (result.rows && result.rows.length)
      ? result.rows.map(postCard).join("")
      : '<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“­</div><p>No posts found. <a href="#" onclick="clearBlogFilter()">Reset</a></p></div>';

    renderPagination("b-pages", result.total, _bState.offset, function(off) { _bState.offset = off; pageBlog(); });
  });
}

function blogSearch() { _bState.q = (document.getElementById("b-srch")||{}).value||""; _bState.offset=0; pageBlog(); }
function setBlogTag(tag) { _bState.tag=tag; _bState.offset=0; pageBlog(); }
function clearBlogFilter() { _bState={q:"",tag:"",offset:0}; pageBlog(); }

/* â”€â”€ BLOG POST DETAIL â”€â”€ */
function pagePost(id) {
  if (!id) { render404(); return; }
  document.getElementById("app").innerHTML = '<div class="container section"><div class="spinner"></div></div>';

  api("post", {id: id}, function(p) {
    var html = '<section class="section"><div class="container" style="max-width:800px">';

    if (p.FeaturedImageURL) {
      html += '<img src="'+esc(p.FeaturedImageURL)+'" alt="'+esc(p.Title)+'" class="featured-img" onerror="this.style.display=\'none\'">';
    }
    html += '<h1>'+esc(p.Title)+'</h1>' +
      '<div class="post-meta">' +
      '<span>ğŸ“… '+esc(fmtDate(p.CreatedDate))+'</span>' +
      (p.AuthorEmail ? '<span>âœï¸ '+esc(p.AuthorEmail.split("@")[0])+'</span>' : "") +
      (p.Tags ? '<span>ğŸ· '+esc(p.Tags)+'</span>' : "") +
      '</div><hr style="border:none;border-top:1px solid var(--border);margin-bottom:24px">' +
      '<div class="rich-content" id="post-body"></div>';

    if (p.Tags) {
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:22px">' +
        p.Tags.split(",").map(function(t) {
          t = t.trim();
          return t ? '<a class="tag-pill" href="#" onclick="event.preventDefault();route(\'blog\',{tag:\''+esc(t)+'\'})">'+esc(t)+'</a>' : "";
        }).join("") + '</div>';
    }

    html += '<div style="margin-top:32px"><button class="btn btn-ghost" onclick="route(\'blog\')">â† Back to Blog</button></div>';
    html += '</div></section>';

    document.getElementById("app").innerHTML = html;
    var el = document.getElementById("post-body");
    if (el) el.innerHTML = p.Content || "";
  }, function() { render404(); });
}

/* â”€â”€ STAFF DASHBOARD â”€â”€ */
function pageStaff() {
  document.getElementById("app").innerHTML =
    '<div class="page-header"><div class="container"><h1>âš™ Staff Dashboard</h1><p>Manage courses, blog posts, users and statistics.</p></div></div>' +
    '<section class="section"><div class="container">' +
    '<div class="stat-grid" id="stat-grid"><div class="spinner"></div></div>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:20px;margin-bottom:20px" id="staff-tables"><div class="spinner"></div></div>' +
    '<div class="card mb-3" id="users-table-wrap"><div class="card-body"><div class="spinner"></div></div></div>' +
    '<div class="card mt-3" style="padding:20px"><h3 style="margin-bottom:12px">ğŸ“Š Category Breakdown</h3><canvas id="cat-chart" height="80"></canvas></div>' +
    '</div></section>';

  api("stats", {}, function(s) {
    document.getElementById("stat-grid").innerHTML = [
      {num:s.totalCourses,    label:"Total Courses"},
      {num:s.publishedCourses,label:"Published Courses"},
      {num:s.totalBlogs,      label:"Total Posts"},
      {num:s.publishedBlogs,  label:"Published Posts"},
      {num:s.activeUsers,     label:"Active Users"},
    ].map(function(x){
      return '<div class="stat-card"><div class="stat-num">'+esc(x.num)+'</div><div class="stat-label">'+esc(x.label)+'</div></div>';
    }).join("");

    if (s.categoryData) {
      var canvas = document.getElementById("cat-chart");
      if (canvas) drawBarChart(canvas, s.categoryData);
    }
  });

  api("allCourses", {}, function(courses) {
    api("allPosts", {}, function(posts) {
      document.getElementById("staff-tables").innerHTML =
        '<div class="card"><div class="card-body">' +
        '<div class="flex-between mb-2"><h3>ğŸ“š Courses</h3><button class="btn btn-primary btn-sm" onclick="route(\'staff-course-form\',{course:null})">+ Add Course</button></div>' +
        buildAdminTable(courses,
          ["Title","Category","Grade","Status"],
          function(c){ return [esc(c.Title), esc(c.Category||""), esc(c.Grade||""), statusBadge(c.Status)]; },
          function(c){ return '<button class="btn btn-primary btn-sm" onclick="_editCourse(\''+esc(c.ID)+'\')" style="mr:3px">Edit</button> <button class="btn btn-danger btn-sm" onclick="_delCourse(\''+esc(c.ID)+'\')" >Delete</button>'; }
        )+'</div></div>' +
        '<div class="card"><div class="card-body">' +
        '<div class="flex-between mb-2"><h3>âœï¸ Blog Posts</h3><button class="btn btn-primary btn-sm" onclick="route(\'staff-blog-form\',{post:null})">+ Add Post</button></div>' +
        buildAdminTable(posts,
          ["Title","Status","Date"],
          function(p){ return [esc(p.Title), statusBadge(p.Status), esc(fmtDate(p.CreatedDate))]; },
          function(p){ return '<button class="btn btn-primary btn-sm" onclick="_editPost(\''+esc(p.ID)+'\')" >Edit</button> <button class="btn btn-danger btn-sm" onclick="_delPost(\''+esc(p.ID)+'\')" >Delete</button>'; }
        )+'</div></div>';
    });
  });

  // Users management table
  api("allUsers", {}, function(users) {
    var wrap = document.getElementById("users-table-wrap");
    if (!wrap) return;
    var roles = ["Student","Editor","Admin"];
    var rows  = users && users.length
      ? '<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Action</th></tr></thead><tbody>' +
        users.map(function(u) {
          var sel = '<select class="form-control" style="padding:4px 8px;font-size:.82rem;width:auto" id="role-'+esc(u.Email)+'">' +
            roles.map(function(r){ return '<option value="'+r+'"'+(u.Role===r?' selected':'')+'>'+r+'</option>'; }).join("") +
            '</select>';
          return '<tr><td>'+esc(u.Name||"â€”")+'</td><td style="font-size:.82rem">'+esc(u.Email)+'</td><td>'+sel+'</td><td>'+esc(u.Status||"")+'</td>' +
                 '<td><button class="btn btn-primary btn-sm" onclick="_updateRole(\''+esc(u.Email)+'\')" >Save</button></td></tr>';
        }).join("") +
        '</tbody></table></div>'
      : '<div class="empty"><div class="empty-icon">ğŸ‘¤</div><p>No users yet.</p></div>';
    wrap.innerHTML =
      '<div class="card-body"><div class="flex-between mb-2"><h3>ğŸ‘¥ User Management</h3>' +
      '<small style="color:var(--muted)">Change a user\'s role and press Save. Students can only view; Editors can add/edit content; Admins have full access.</small>' +
      '</div>' + rows + '</div>';
  });
}

function buildAdminTable(rows, cols, cellsFn, actionsFn) {
  if (!rows || !rows.length) return '<div class="empty"><div class="empty-icon">ğŸ“­</div><p>None yet.</p></div>';
  return '<div style="overflow-x:auto"><table class="data-table"><thead><tr>' +
    cols.map(function(c){ return '<th>'+esc(c)+'</th>'; }).join("") + '<th>Actions</th>' +
    '</tr></thead><tbody>' +
    rows.map(function(row) {
      return '<tr>'+cellsFn(row).map(function(v){ return '<td>'+v+'</td>'; }).join("")+
             '<td><div class="actions">'+actionsFn(row)+'</div></td></tr>';
    }).join("") +
    '</tbody></table></div>';
}

function _editCourse(id) {
  api("allCourses", {}, function(courses) {
    var c = courses.find(function(x){ return x.ID === id; });
    route("staff-course-form", { course: c || null });
  });
}
function _editPost(id) {
  api("allPosts", {}, function(posts) {
    var p = posts.find(function(x){ return x.ID === id; });
    route("staff-blog-form", { post: p || null });
  });
}
function _delCourse(id) {
  if (!confirm("Delete this course? This cannot be undone.")) return;
  apiPost("deleteCourse", {id: id}, function() { toast("Course deleted."); pageStaff(); });
}
function _delPost(id) {
  if (!confirm("Delete this post? This cannot be undone.")) return;
  apiPost("deletePost", {id: id}, function() { toast("Post deleted."); pageStaff(); });
}
function _updateRole(email) {
  var sel = document.getElementById("role-" + email);
  if (!sel) return;
  var newRole = sel.value;
  if (!confirm("Change role of " + email + " to " + newRole + "?")) return;
  apiPost("updateUserRole", {email: email, role: newRole}, function() {
    toast("Role updated to " + newRole + " for " + email + " âœ“");
    pageStaff();
  });
}

function drawBarChart(canvas, data) {
  var keys = Object.keys(data);
  if (!keys.length) { canvas.style.display="none"; return; }
  var ctx = canvas.getContext("2d");
  var W   = canvas.offsetWidth || 500;
  canvas.width = W; canvas.height = 120;
  var bW = (W - 40) / keys.length - 8;
  var max = Math.max.apply(null, keys.map(function(k){ return data[k]; }));
  var clrs = ["#1e3a5f","#2d6a9f","#f0b429","#2f855a","#c53030","#553c9a","#dd6b20"];
  keys.forEach(function(key, i) {
    var val = data[key];
    var bh  = Math.round((val / max) * 80);
    var x   = 20 + i * (bW + 8);
    var y   = 100 - bh;
    ctx.fillStyle = clrs[i % clrs.length];
    ctx.beginPath();
    if (ctx.roundRect) ctx.roundRect(x, y, bW, bh, 4); else ctx.rect(x, y, bW, bh);
    ctx.fill();
    ctx.fillStyle = "#1a202c"; ctx.font = "11px sans-serif"; ctx.textAlign = "center";
    ctx.fillText(key.slice(0,10), x + bW/2, 115);
    ctx.fillStyle = "#fff";
    ctx.fillText(val, x + bW/2, y + 14);
  });
}

/* â”€â”€ STAFF COURSE FORM â”€â”€ */
function pageStaffCourseForm(course) {
  var isEdit = course && course.ID;
  var v = function(f){ return isEdit ? esc(course[f]||"") : ""; };
  var toolbarHTML = ['Bold','Italic','Underline','H2','H3','UL','OL','Link','Quote'].map(function(c){
    return '<button type="button" onclick="fmt(\''+c+'\')">'+c+'</button>';
  }).join("");

  document.getElementById("app").innerHTML =
    '<div class="page-header"><div class="container"><h1>'+(isEdit?"Edit":"Add")+' Course</h1></div></div>' +
    '<section class="section"><div class="container" style="max-width:720px"><div class="card"><div class="card-body">' +
    (isEdit ? '<input type="hidden" id="f-id" value="'+v("ID")+'">' : "") +
    '<div class="form-group"><label class="form-label">Title <span class="req">*</span></label>' +
    '<input id="f-title" class="form-control" value="'+v("Title")+'" placeholder="Course title"></div>' +
    '<div class="form-group"><label class="form-label">Description</label>' +
    '<textarea id="f-desc" class="form-control">'+v("Description")+'</textarea></div>' +
    '<div class="form-row">' +
    '<div class="form-group"><label class="form-label">Instructor</label><input id="f-instr" class="form-control" value="'+v("Instructor")+'"></div>' +
    '<div class="form-group"><label class="form-label">Category</label><input id="f-cat" class="form-control" value="'+v("Category")+'" placeholder="e.g. Career, Resumeâ€¦"></div>' +
    '</div>' +
    '<div class="form-group"><label class="form-label">Grade / Class Level</label>' +
    '<select id="f-grade" class="form-control">' +
    '<option value="">â€” Select grade â€”</option>' +
    ['Class 7','Class 8','Class 9','Class 10','Class 11','Class 12'].map(function(g){
      return '<option value="'+g+'"'+(isEdit&&course.Grade===g?' selected':'')+'>'+g+'</option>';
    }).join("") +
    '</select></div>' +
    '<div class="form-group"><label class="form-label">Thumbnail URL</label>' +
    '<input id="f-thumb" class="form-control" value="'+v("ThumbnailURL")+'" placeholder="https://â€¦"></div>' +
    '<div class="form-group"><label class="form-label">YouTube URL</label>' +
    '<input id="f-yt" class="form-control" value="'+v("YouTubeURL")+'" placeholder="https://www.youtube.com/watch?v=â€¦"></div>' +
    '<div class="form-group"><label class="form-label">PDF Google Drive Link</label>' +
    '<input id="f-pdf" class="form-control" value="'+v("PDFLink")+'" placeholder="https://drive.google.com/file/d/â€¦">' +
    '<div class="form-hint">Must be a Google Drive share link.</div></div>' +
    '<div class="form-group"><label class="form-label">Content</label>' +
    '<div class="toolbar">'+toolbarHTML+'</div>' +
    '<div id="f-content" class="editor" contenteditable="true">'+(isEdit&&course.Content?course.Content:"")+'</div></div>' +
    '<div class="form-group"><label class="form-label">Status</label>' +
    '<select id="f-status" class="form-control">' +
    '<option value="Draft"'+(isEdit&&course.Status==="Draft"?" selected":"")+'>Draft</option>' +
    '<option value="Published"'+(isEdit&&course.Status==="Published"?" selected":"")+'>Published</option>' +
    '</select></div>' +
    '<div style="display:flex;gap:10px;margin-top:8px">' +
    '<button class="btn btn-primary" onclick="submitCourse()">ğŸ’¾ Save Course</button>' +
    '<button class="btn btn-ghost" onclick="route(\'staff\')">Cancel</button>' +
    '</div></div></div></div></section>';
}

function submitCourse() {
  var idEl = document.getElementById("f-id");
  var payload = {
    id:          idEl ? idEl.value : "",
    title:       (document.getElementById("f-title") ||{}).value || "",
    description: (document.getElementById("f-desc")  ||{}).value || "",
    instructor:  (document.getElementById("f-instr") ||{}).value || "",
    category:    (document.getElementById("f-cat")   ||{}).value || "",
    grade:       (document.getElementById("f-grade") ||{}).value || "",
    thumbnailUrl:(document.getElementById("f-thumb") ||{}).value || "",
    youtubeUrl:  (document.getElementById("f-yt")    ||{}).value || "",
    pdfLink:     (document.getElementById("f-pdf")   ||{}).value || "",
    content:     (document.getElementById("f-content")||{}).innerHTML || "",
    status:      (document.getElementById("f-status")||{}).value || "Draft",
  };
  if (!payload.title.trim()) { toast("Title is required.", "err"); return; }
  apiPost("saveCourse", {data: payload}, function() { toast("Course saved! ğŸ‰"); route("staff"); });
}

/* â”€â”€ STAFF BLOG FORM â”€â”€ */
function pageStaffBlogForm(post) {
  var isEdit = post && post.ID;
  var v = function(f){ return isEdit ? esc(post[f]||"") : ""; };
  var toolbarHTML = ['Bold','Italic','Underline','H2','H3','UL','OL','Link','Quote'].map(function(c){
    return '<button type="button" onclick="fmt(\''+c+'\')">'+c+'</button>';
  }).join("");

  document.getElementById("app").innerHTML =
    '<div class="page-header"><div class="container"><h1>'+(isEdit?"Edit":"Add")+' Post</h1></div></div>' +
    '<section class="section"><div class="container" style="max-width:720px"><div class="card"><div class="card-body">' +
    (isEdit ? '<input type="hidden" id="p-id" value="'+v("ID")+'">' : "") +
    '<div class="form-group"><label class="form-label">Title <span class="req">*</span></label>' +
    '<input id="p-title" class="form-control" value="'+v("Title")+'" placeholder="Post title"></div>' +
    '<div class="form-group"><label class="form-label">Featured Image URL</label>' +
    '<input id="p-img" class="form-control" value="'+v("FeaturedImageURL")+'" placeholder="https://â€¦"></div>' +
    '<div class="form-group"><label class="form-label">Tags <span class="form-hint">(comma-separated)</span></label>' +
    '<input id="p-tags" class="form-control" value="'+v("Tags")+'" placeholder="interview, career, tips"></div>' +
    '<div class="form-group"><label class="form-label">Content <span class="req">*</span></label>' +
    '<div class="toolbar">'+toolbarHTML+'</div>' +
    '<div id="p-content" class="editor" contenteditable="true">'+(isEdit&&post.Content?post.Content:"")+'</div></div>' +
    '<div class="form-group"><label class="form-label">Status</label>' +
    '<select id="p-status" class="form-control">' +
    '<option value="Draft"'+(isEdit&&post.Status==="Draft"?" selected":"")+'>Draft</option>' +
    '<option value="Published"'+(isEdit&&post.Status==="Published"?" selected":"")+'>Published</option>' +
    '</select></div>' +
    '<div style="display:flex;gap:10px;margin-top:8px">' +
    '<button class="btn btn-primary" onclick="submitPost()">ğŸ’¾ Save Post</button>' +
    '<button class="btn btn-ghost" onclick="route(\'staff\')">Cancel</button>' +
    '</div></div></div></div></section>';
}

function submitPost() {
  var idEl = document.getElementById("p-id");
  var payload = {
    id:              idEl ? idEl.value : "",
    title:           (document.getElementById("p-title")  ||{}).value || "",
    featuredImageUrl:(document.getElementById("p-img")    ||{}).value || "",
    tags:            (document.getElementById("p-tags")   ||{}).value || "",
    content:         (document.getElementById("p-content")||{}).innerHTML || "",
    status:          (document.getElementById("p-status") ||{}).value || "Draft",
  };
  if (!payload.title.trim())   { toast("Title is required.", "err"); return; }
  if (!stripHtml(payload.content||"")) { toast("Content is required.", "err"); return; }
  apiPost("savePost", {data: payload}, function() { toast("Post saved! ğŸ‰"); route("staff"); });
}
</script>
</body>
</html>
